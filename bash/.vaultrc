#!/usr/bin/env bash

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# Aliases

alias vdebug="dlv --listen=:2345 --headless=true --api-version=2 exec ./pkg/darwin_amd64/vault -- server -dev -log-level=debug -dev-root-token-id=root"

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# Functions

# run vault in dev mode
# optionally pass in "&" to run in the background
vdev() {
  vault server \
    -dev \
    -log-level="debug" \
    -dev-ha \
    -dev-transactional \
    -dev-root-token-id=root \
    "$@"
}

vlocal() {
  export VAULT_DEV_ROOT_TOKEN_ID="root"
  export VAULT_TOKEN="root"
  export VAULT_ADDR="http://127.0.0.1:8200"
}

vunset() {
  unset VAULT_DEV_ROOT_TOKEN_ID
  unset VAULT_TOKEN
  unset VAULT_ADDR
}

# print vault env vars and processes
vv() {
  echo "VAULT_DEV_ROOT_TOKEN_ID: $VAULT_DEV_ROOT_TOKEN_ID"
  echo "VAULT_TOKEN: $VAULT_TOKEN"
  echo "VAULT_ADDR: $VAULT_ADDR"
  output=$(ps aux | awk 'NR==1 || /vault server/' | grep -v awk)
  readarray -t lines <<<"$output"
  if [[ -n ${lines[1]} ]]; then
    echo
    echo "$output"
  fi
}

# kill vault proccess
vkill() {
  ps aux | \
    grep "vault server" | \
    grep -v grep | \
    awk '{print $2}' | \
    xargs kill -9
}

